<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>巨戟アーティア リセット回数カウンター</title>

  <style>
    :root{
      --border:#ddd;
      --muted:#666;
      --bg:#fff;
      --soft:#fafafa;
      --danger:#b00020;
      --ok:#0a7a2f;
      --radius:12px;
      --gap:12px;
      --pad:14px;
    }

    *{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif;
      background: var(--bg);
      color:#111;
      padding: 16px;
      max-width: 980px;
      margin: 0 auto;
    }

    h1{ font-size:20px; margin: 0 0 10px; }
    h2{ font-size:16px; margin: 0 0 10px; }

    .muted{ color:var(--muted); font-size:13px; line-height:1.55; }

    .card{
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding: var(--pad);
      margin: 12px 0;
    }

    /* --- Form controls --- */
    input[type="text"], input[type="number"], select, textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid #ccc;
      border-radius: 10px;
      font-size: 16px; /* iOS zoom対策 */
      background:#fff;
    }
    input[readonly]{ background: #f7f7f7; }
    textarea{
      min-height: 110px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    button{
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background:#fff;
      font-weight:700;
      cursor:pointer;
    }
    button:hover{ background:#f5f5f5; }

    .badge{
      display:inline-block;
      padding:2px 8px;
      border:1px solid var(--border);
      border-radius:999px;
      font-size:12px;
      background: var(--soft);
      color:#444;
    }

    /* --- Responsive layout helpers --- */
    .grid-2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
      align-items:start;
    }
    .grid-3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: var(--gap);
      align-items:start;
    }
    .grid-4{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: var(--gap);
      align-items:start;
    }

    .field label{
      display:block;
      font-size: 13px;
      color:#333;
      font-weight:800;
      margin: 0 0 6px;
    }

    /* --- Summary pills --- */
    .resultGrid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: var(--gap);
    }
    .pill{
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      background: var(--soft);
      min-width: 0;
    }
    .pill .label{ color:var(--muted); font-size:12px; margin-bottom:4px; }
    .pill .value{ font-size: 22px; font-weight: 900; word-break: break-word; }

    /* --- Device section (desktop: row, mobile: stacked cards) --- */
    .deviceHeader{
      display:grid;
      grid-template-columns: 1.1fr 1fr 1fr 1fr 0.9fr;
      gap: 10px;
      font-weight:900;
      color:#333;
      margin-bottom: 10px;
    }

    .deviceRow{
      display:grid;
      grid-template-columns: 1.1fr 1fr 1fr 1fr 0.9fr;
      gap: 10px;
      align-items:center;
      margin-top: 10px;
    }

    .deviceRow .nameFixed{
      font-weight:900;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background:#f7f7f7;
      text-align:center;
    }

    .statusBox{
      margin-top: 12px;
    }
    .warn{ color: var(--danger); font-weight:900; }
    .ok{ color: var(--ok); font-weight:900; }

    /* --- Records list --- */
    .recordsHeader{
      display:grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1.2fr 0.8fr;
      gap: 10px;
      align-items:center;
      font-weight:900;
      color:#333;
      padding-bottom: 10px;
    }
    .recordRow{
      display:grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1.2fr 0.8fr;
      gap: 10px;
      align-items:center;
      padding: 10px 0;
      border-top: 1px solid #eee;
    }
    .right{ text-align:right; }

    .tiny{ font-size:12px; color: var(--muted); margin-top:10px; }

    /* --- Mobile overrides --- */
    @media (max-width: 720px){
      body{ padding: 14px; }

      .grid-2, .grid-3, .grid-4{
        grid-template-columns: 1fr;
      }

      .resultGrid{
        grid-template-columns: 1fr;
      }

      /* Device table -> stacked cards */
      .deviceHeader{ display:none; }
      .deviceRow{
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: #fff;
      }
      .deviceRow + .deviceRow{ margin-top: 12px; }

      .deviceRow .pair{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .deviceRow .pair .field label{ margin-bottom: 6px; }
      .deviceRow .pair.single{ grid-template-columns: 1fr; }

      /* Records -> stacked cards */
      .recordsHeader{ display:none; }
      .recordRow{
        grid-template-columns: 1fr;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 12px;
        background:#fff;
        margin-top: 10px;
      }
      .recordRow .row2{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .recordRow .row2 > div{ min-width:0; }
      .recordRow .row2 .right{ text-align:left; }

      .actions button{
        flex: 1 1 auto;
      }
    }
  </style>
</head>

<body>
  <h1>巨戟アーティア リセット回数カウンター</h1>
  <div class="muted">
    攻撃 / 会心 / 属性 の遺装置について <span class="badge">start</span> と <span class="badge">now</span> を入力し、武器の <b>巨戟性能タイプ</b>（=どれが500pts扱いか）を選択します。<br>
    ルール：一致した装置は <b>500pts/個</b>、それ以外は <b>250pts/個</b>。リセット回数は <b>総消費pts ÷ 1500</b> の切り捨てです。
  </div>

  <div class="card">
    <div class="grid-2">
      <div class="field">
        <label for="weaponType">武器の巨戟性能タイプ（=500ptsになる装置）</label>
        <select id="weaponType"></select>
      </div>
      <div class="muted" style="align-self:end;">
        ※「武器タイプと一致する装置」を選びます（攻撃/会心/属性のどれか）
      </div>
    </div>
  </div>

  <div class="card">
    <div class="deviceHeader">
      <div>装置</div><div>start</div><div>now</div><div>消費数</div><div>pts/個</div>
    </div>

    <!-- 攻撃 -->
    <div class="deviceRow device" data-idx="0" data-key="attack">
      <div class="nameFixed">攻撃</div>

      <div class="pair">
        <div class="field">
          <label>start</label>
          <input type="number" class="start" value="0" min="0" step="1" inputmode="numeric" />
        </div>
        <div class="field">
          <label>now</label>
          <input type="number" class="now" value="0" min="0" step="1" inputmode="numeric" />
        </div>
      </div>

      <div class="pair">
        <div class="field">
          <label>消費数</label>
          <input type="number" class="use" value="0" readonly />
        </div>
        <div class="field">
          <label>pts/個</label>
          <input type="text" class="ppc" value="250" readonly />
        </div>
      </div>
    </div>

    <!-- 会心 -->
    <div class="deviceRow device" data-idx="1" data-key="crit">
      <div class="nameFixed">会心</div>

      <div class="pair">
        <div class="field">
          <label>start</label>
          <input type="number" class="start" value="0" min="0" step="1" inputmode="numeric" />
        </div>
        <div class="field">
          <label>now</label>
          <input type="number" class="now" value="0" min="0" step="1" inputmode="numeric" />
        </div>
      </div>

      <div class="pair">
        <div class="field">
          <label>消費数</label>
          <input type="number" class="use" value="0" readonly />
        </div>
        <div class="field">
          <label>pts/個</label>
          <input type="text" class="ppc" value="250" readonly />
        </div>
      </div>
    </div>

    <!-- 属性 -->
    <div class="deviceRow device" data-idx="2" data-key="elem">
      <div class="nameFixed">属性</div>

      <div class="pair">
        <div class="field">
          <label>start</label>
          <input type="number" class="start" value="0" min="0" step="1" inputmode="numeric" />
        </div>
        <div class="field">
          <label>now</label>
          <input type="number" class="now" value="0" min="0" step="1" inputmode="numeric" />
        </div>
      </div>

      <div class="pair">
        <div class="field">
          <label>消費数</label>
          <input type="number" class="use" value="0" readonly />
        </div>
        <div class="field">
          <label>pts/個</label>
          <input type="text" class="ppc" value="250" readonly />
        </div>
      </div>
    </div>

    <div id="warningArea" class="statusBox muted"></div>

    <div class="actions">
      <button id="btnResetInputs" type="button">数値を0に戻す</button>
      <button id="btnSetNowAsStart" type="button">現在(now)をstartに反映（区切り）</button>
      <button id="btnCopySummary" type="button">計算結果をコピー</button>
    </div>
  </div>

  <div class="card">
    <div class="resultGrid">
      <div class="pill">
        <div class="label">総消費pts</div>
        <div class="value" id="totalPts">0</div>
      </div>
      <div class="pill">
        <div class="label">リセット回数（1500ptsごと）</div>
        <div class="value" id="resetCount">0</div>
      </div>
      <div class="pill">
        <div class="label">余りpts（次のリセットまで）</div>
        <div class="value" id="remainPts">0</div>
      </div>
    </div>
    <div class="muted" style="margin-top:10px;">
      リセット回数 = ⌊総消費pts / 1500⌋、余りpts = 総消費pts mod 1500
    </div>
  </div>

  <div class="card">
    <h2>記録（武器名 + リセット回数）</h2>

    <div class="grid-2">
      <div class="field">
        <label for="weaponName">武器名（記録時に入力）</label>
        <input id="weaponName" type="text" placeholder="例：禁戒のデスヴァンケル" />
      </div>
      <div class="muted" style="align-self:end;">
        「記録する」でこの時点の <span class="badge">巨戟タイプ</span> / <span class="badge">リセット回数</span> / <span class="badge">総消費pts</span> を保存（ブラウザ内）
      </div>
    </div>

    <div class="actions">
      <button id="btnAddRecord" type="button">記録する</button>
      <button id="btnClearRecords" type="button">記録を全消去</button>
      <button id="btnExportJson" type="button">JSON書き出し</button>
      <button id="btnImportJson" type="button">JSON読み込み</button>
    </div>

    <div id="recordsArea" style="margin-top:12px;">
      <div class="recordsHeader">
        <div>武器名（編集可）</div>
        <div>巨戟タイプ</div>
        <div class="right">リセット回数</div>
        <div class="right">総消費pts</div>
        <div>日時</div>
        <div class="right">操作</div>
      </div>
      <div id="recordsList" class="muted">（まだ記録がありません）</div>
    </div>

    <div id="jsonPanel" style="display:none; margin-top:12px;">
      <div class="muted" style="margin-bottom:8px;">
        JSONを貼り付けて「読み込み」、または「書き出し」内容をコピーしてバックアップできます。
      </div>
      <textarea id="jsonText"></textarea>
      <div class="actions">
        <button id="btnDoImport" type="button">このJSONを読み込む</button>
        <button id="btnCloseJson" type="button">閉じる</button>
      </div>
    </div>

    <div class="tiny">
      保存先：このブラウザの localStorage（同じ端末・同じブラウザなら残ります。端末移行はJSON書き出し/読み込み）
    </div>
  </div>

<script>
(() => {
  const STORAGE_KEY = "gigeki_artia_reset_records_v2";

  const DEVICES = [
    { key: "attack", label: "攻撃" },
    { key: "crit",   label: "会心" },
    { key: "elem",   label: "属性" },
  ];

  const weaponTypeEl = document.getElementById("weaponType");
  const weaponNameEl = document.getElementById("weaponName");

  const warningArea = document.getElementById("warningArea");
  const totalPtsEl = document.getElementById("totalPts");
  const resetCountEl = document.getElementById("resetCount");
  const remainPtsEl = document.getElementById("remainPts");

  const recordsListEl = document.getElementById("recordsList");
  const jsonPanelEl = document.getElementById("jsonPanel");
  const jsonTextEl = document.getElementById("jsonText");

  const deviceRows = Array.from(document.querySelectorAll(".deviceRow.device"));

  function clampInt(v){
    const n = Number(v);
    if (!Number.isFinite(n)) return 0;
    return Math.max(0, Math.floor(n));
  }

  function nowIsoNoSeconds(){
    const d = new Date();
    const pad = (x) => String(x).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function rebuildWeaponTypeOptions(){
    const prev = weaponTypeEl.value;
    weaponTypeEl.innerHTML = "";
    DEVICES.forEach((dev, idx) => {
      const opt = document.createElement("option");
      opt.value = String(idx);
      opt.textContent = `${dev.label} が500pts扱い（巨戟タイプ一致）`;
      weaponTypeEl.appendChild(opt);
    });
    weaponTypeEl.value = (prev !== "" && weaponTypeEl.querySelector(`option[value="${prev}"]`)) ? prev : "0";
  }

  function getSnapshot(){
    const weaponIdx = Number(weaponTypeEl.value);
    let totalPts = 0;
    const warnings = [];

    const perDevice = DEVICES.map((dev, idx) => {
      const row = deviceRows[idx];
      const startEl = row.querySelector(".start");
      const nowEl   = row.querySelector(".now");

      const start = clampInt(startEl.value);
      const now   = clampInt(nowEl.value);

      if (String(start) !== startEl.value) startEl.value = start;
      if (String(now) !== nowEl.value) nowEl.value = now;

      const used = start - now;
      const ppc  = (idx === weaponIdx) ? 500 : 250;
      const usedPts = used * ppc;

      if (used < 0) warnings.push(`「${dev.label}」が start < now です（差分がマイナス）。途中で増えた場合は「現在をstartに反映（区切り）」を使ってください。`);

      totalPts += usedPts;
      return { key: dev.key, label: dev.label, start, now, used, ppc, usedPts };
    });

    const resetCount = Math.floor(totalPts / 1500);
    const remain = ((totalPts % 1500) + 1500) % 1500;

    return {
      weaponIdx,
      weaponLabel: DEVICES[weaponIdx]?.label ?? "攻撃",
      perDevice,
      totalPts,
      resetCount,
      remain,
      warnings,
    };
  }

  function renderCalc(){
    const snap = getSnapshot();

    snap.perDevice.forEach((d, idx) => {
      const row = deviceRows[idx];
      row.querySelector(".use").value = d.used;
      row.querySelector(".ppc").value = d.ppc;
    });

    totalPtsEl.textContent = String(snap.totalPts);
    resetCountEl.textContent = String(snap.resetCount);
    remainPtsEl.textContent = String(snap.remain);

    if (snap.warnings.length){
      warningArea.innerHTML = `<div class="warn">⚠ 警告</div><div>${snap.warnings.map(w => "・" + w).join("<br>")}</div>`;
    } else {
      warningArea.innerHTML = `<div class="ok">OK</div><div>差分はすべて0以上です。</div>`;
    }
  }

  // Records
  function loadRecords(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      const data = JSON.parse(raw);
      return Array.isArray(data) ? data : [];
    } catch { return []; }
  }
  function saveRecords(records){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
  }
  function makeId(){
    return `${Date.now()}_${Math.random().toString(16).slice(2)}`;
  }

  function renderRecords(){
    const records = loadRecords();
    if (!records.length){
      recordsListEl.textContent = "（まだ記録がありません）";
      return;
    }
    recordsListEl.innerHTML = "";

    records.forEach((rec) => {
      const row = document.createElement("div");
      row.className = "recordRow";
      row.dataset.id = rec.id;

      // Weapon name (editable)
      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.value = rec.weaponName ?? "";
      nameInput.placeholder = "武器名";
      nameInput.addEventListener("input", () => {
        const rs = loadRecords();
        const i = rs.findIndex(r => r.id === rec.id);
        if (i >= 0){
          rs[i].weaponName = nameInput.value;
          saveRecords(rs);
        }
      });

      // Desktop cells
      const typeDiv = document.createElement("div");
      typeDiv.textContent = rec.weaponTypeLabel ?? "";

      const resetDiv = document.createElement("div");
      resetDiv.className = "right";
      resetDiv.textContent = String(rec.resetCount ?? 0);

      const ptsDiv = document.createElement("div");
      ptsDiv.className = "right";
      ptsDiv.textContent = String(rec.totalPts ?? 0);

      const timeDiv = document.createElement("div");
      timeDiv.textContent = rec.savedAt ?? "";

      const actionsDiv = document.createElement("div");
      actionsDiv.className = "right";
      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.textContent = "削除";
      delBtn.addEventListener("click", () => {
        const rs = loadRecords().filter(r => r.id !== rec.id);
        saveRecords(rs);
        renderRecords();
      });
      actionsDiv.appendChild(delBtn);

      // For mobile: group numeric fields in 2-col grid (optional)
      const row2 = document.createElement("div");
      row2.className = "row2";
      row2.appendChild(typeDiv);
      row2.appendChild(resetDiv);
      const row2b = document.createElement("div");
      row2b.className = "row2";
      row2b.appendChild(ptsDiv);
      row2b.appendChild(timeDiv);

      // We keep DOM simple: on desktop, CSS grid will align; on mobile, it becomes stacked.
      row.appendChild(nameInput);
      row.appendChild(typeDiv);
      row.appendChild(resetDiv);
      row.appendChild(ptsDiv);
      row.appendChild(timeDiv);
      row.appendChild(actionsDiv);

      recordsListEl.appendChild(row);
    });
  }

  function addRecord(){
    const snap = getSnapshot();
    const weaponName = (weaponNameEl.value || "").trim();

    const rec = {
      id: makeId(),
      weaponName,
      weaponTypeIdx: snap.weaponIdx,
      weaponTypeLabel: snap.weaponLabel,
      resetCount: snap.resetCount,
      totalPts: snap.totalPts,
      savedAt: nowIsoNoSeconds(),
    };

    const records = loadRecords();
    records.unshift(rec);
    saveRecords(records);
    renderRecords();
  }

  // Buttons
  document.getElementById("btnResetInputs").addEventListener("click", () => {
    deviceRows.forEach(row => {
      row.querySelector(".start").value = 0;
      row.querySelector(".now").value = 0;
    });
    renderCalc();
  });

  document.getElementById("btnSetNowAsStart").addEventListener("click", () => {
    deviceRows.forEach(row => {
      const now = clampInt(row.querySelector(".now").value);
      row.querySelector(".start").value = now;
    });
    renderCalc();
  });

  document.getElementById("btnCopySummary").addEventListener("click", async () => {
    const snap = getSnapshot();
    const lines = [];
    lines.push(`巨戟アーティア リセット回数カウンター`);
    lines.push(`巨戟タイプ一致（500pts）: ${snap.weaponLabel}`);
    lines.push(`---`);
    snap.perDevice.forEach(d => {
      lines.push(`${d.label}: start=${d.start}, now=${d.now}, 消費=${d.used}, pts/個=${d.ppc}, 消費pts=${d.usedPts}`);
    });
    lines.push(`---`);
    lines.push(`総消費pts=${snap.totalPts}`);
    lines.push(`リセット回数=${snap.resetCount}`);
    lines.push(`余りpts=${snap.remain}`);

    try{
      await navigator.clipboard.writeText(lines.join("\n"));
      alert("コピーしました。");
    }catch{
      const ta = document.createElement("textarea");
      ta.value = lines.join("\n");
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      alert("コピーしました（互換モード）。");
    }
  });

  document.getElementById("btnAddRecord").addEventListener("click", () => {
    const name = (weaponNameEl.value || "").trim();
    if (!name){
      const ok = confirm("武器名が空です。このまま記録しますか？");
      if (!ok) return;
    }
    addRecord();
  });

  document.getElementById("btnClearRecords").addEventListener("click", () => {
    const ok = confirm("記録をすべて削除します。よろしいですか？");
    if (!ok) return;
    localStorage.removeItem(STORAGE_KEY);
    renderRecords();
  });

  document.getElementById("btnExportJson").addEventListener("click", () => {
    const records = loadRecords();
    jsonTextEl.value = JSON.stringify(records, null, 2);
    jsonPanelEl.style.display = "block";
    jsonTextEl.focus();
    jsonTextEl.select();
  });

  document.getElementById("btnImportJson").addEventListener("click", () => {
    jsonTextEl.value = "";
    jsonPanelEl.style.display = "block";
    jsonTextEl.focus();
  });

  document.getElementById("btnDoImport").addEventListener("click", () => {
    try{
      const data = JSON.parse(jsonTextEl.value || "[]");
      if (!Array.isArray(data)) throw new Error("JSONは配列ではありません。");

      const cleaned = data.map((r) => ({
        id: String(r.id || makeId()),
        weaponName: String(r.weaponName ?? ""),
        weaponTypeIdx: Number.isFinite(Number(r.weaponTypeIdx)) ? Number(r.weaponTypeIdx) : 0,
        weaponTypeLabel: String(r.weaponTypeLabel ?? ""),
        resetCount: Number.isFinite(Number(r.resetCount)) ? Number(r.resetCount) : 0,
        totalPts: Number.isFinite(Number(r.totalPts)) ? Number(r.totalPts) : 0,
        savedAt: String(r.savedAt ?? ""),
      }));

      saveRecords(cleaned);
      renderRecords();
      alert("読み込みました。");
    }catch(e){
      alert("JSONの解析に失敗しました：\n" + (e && e.message ? e.message : String(e)));
    }
  });

  document.getElementById("btnCloseJson").addEventListener("click", () => {
    jsonPanelEl.style.display = "none";
  });

  // Input listeners
  weaponTypeEl.addEventListener("change", renderCalc);
  deviceRows.forEach(row => {
    row.querySelector(".start").addEventListener("input", renderCalc);
    row.querySelector(".now").addEventListener("input", renderCalc);
  });

  // Init
  rebuildWeaponTypeOptions();
  renderCalc();
  renderRecords();
})();
</script>
</body>
</html>
